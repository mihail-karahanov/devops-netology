# Домашнее задание к занятию "7.3. Основы и принцип работы Терраформ" - Михаил Караханов

## Задача 1. Создадим бэкэнд в S3 (необязательно, но крайне желательно)

>Если в рамках предыдущего задания у вас уже есть аккаунт AWS, то давайте продолжим знакомство со взаимодействием
терраформа и aws.
>
>1. Создайте s3 бакет, iam роль и пользователя от которого будет работать терраформ. Можно создать отдельного пользователя,
а можно использовать созданного в рамках предыдущего задания, просто добавьте ему необходимы права, как описано [здесь](https://www.terraform.io/docs/backends/types/s3.html).
>1. Зарегистрируйте бэкэнд в терраформ проекте как описано по ссылке выше.

К сожалению, нет возможности использовать AWS...

## Задача 2. Инициализируем проект и создаем воркспейсы

1. Выполните `terraform init`:
   * если был создан бэкэнд в S3, то терраформ создат файл стейтов в S3 и запись в таблице dynamodb.
   * иначе будет создан локальный файл со стейтами.
2. Создайте два воркспейса `stage` и `prod`.
3. В уже созданный `aws_instance` добавьте зависимость типа инстанса от вокспейса, что бы в разных ворскспейсах использовались разные `instance_type`.
4. Добавим `count`. Для `stage` должен создаться один экземпляр `ec2`, а для `prod` два.
5. Создайте рядом еще один `aws_instance`, но теперь определите их количество при помощи `for_each`, а не `count`.
6. Что бы при изменении типа инстанса не возникло ситуации, когда не будет ни одного инстанса добавьте параметр
жизненного цикла `create_before_destroy = true` в один из рессурсов `aws_instance`.
7. При желании поэкспериментируйте с другими параметрами и рессурсами.

## Выполнение Задачи 2 (Yandex.Cloud)

1. Выполнил `terraform init` в созданном ранее каталоге `terraform`
2. Создал два workspace `stage` и `prod` командой `terraform workspace new <workspace_name>`. Список workspace:

    ![workspace_list](/img/07_03_workspace_list.png)

3. Добавил локальную переменную `instance_type_map` в файл `main.tf`:

    ```ruby
    locals {
    instance_type_map = {
        stage = "standard-v3"
        prod  = "standard-v1"
    }
    }
    ```

    В уже созданный `yandex_compute_instance` добавил зависимость `platform_id` от воркспейса:

    ```ruby
    resource "yandex_compute_instance" "test" {
      name        = "test-srv"
      hostname    = "test-srv1.netology.local"
      platform_id = local.instance_type_map[terraform.workspace]
      zone        = var.yc_default_zone
    ```

В виде результата работы пришлите:

* Вывод команды `terraform workspace list`.
* Вывод команды `terraform plan` для воркспейса `prod`.  
